--!strict
--!optimize 2

local radius = 100
local scan_int = 2.0
local debounce = 0.05

local pink = Color3.fromRGB(255, 105, 180)
local line = Color3.fromRGB(255, 100, 150)
local bg = Color3.fromRGB(25, 25, 30)
local border = Color3.fromRGB(80, 80, 90)
local text = Color3.fromRGB(255, 255, 255)

local ws = game:GetService("Workspace")
local rs = game:GetService("RunService")
local f = DrawingImmediate

local cache = {}
local cache_size = 0
local last_scan = 0
local on = true
local cur = nil
local cur_dist = radius
local last_key = 0
local frame = 0

local function has_pos(obj)
    if not obj then return false end
    local ok = pcall(function()
        return typeof(obj.Position) == "vector"
    end)
    return ok
end

local function get_pos(obj)
    if not obj then return nil end
    
    local ok, pos = pcall(function()
        return obj.Position
    end)
    
    if ok and typeof(pos) == "vector" then
        return pos
    end
    
    local ok2, cf = pcall(function()
        return obj.CFrame
    end)
    
    if ok2 and cf and cf.Position then
        return cf.Position
    end
    
    return nil
end

local function get_path(obj)
    if not obj then return "" end
    
    local parts = {}
    local cur = obj
    
    while cur and cur ~= game do
        table.insert(parts, 1, cur.Name)
        cur = cur.Parent
    end
    
    return table.concat(parts, " > ")
end

local function get_col(obj)
    if not obj then return "N/A" end
    
    local ok, col = pcall(function()
        return obj.CanCollide
    end)
    
    if ok and typeof(col) == "boolean" then
        return col and "ON" or "OFF"
    end
    
    if obj:IsA("Model") then
        local has = false
        local all_off = true
        
        for _, child in obj:GetChildren() do
            local ok2, child_col = pcall(function()
                return child.CanCollide
            end)
            
            if ok2 and typeof(child_col) == "boolean" then
                has = true
                if child_col then
                    all_off = false
                end
            end
        end
        
        if has then
            return all_off and "OFF" or "MIXED"
        end
    end
    
    return "N/A"
end

local function toggle_col(obj)
    if not obj then return false end
    
    local ok, cur = pcall(function()
        return obj.CanCollide
    end)
    
    if ok and typeof(cur) == "boolean" then
        local ok2 = pcall(function()
            obj.CanCollide = not cur
        end)
        return ok2
    end
    
    if obj:IsA("Model") then
        local any = false
        
        for _, child in obj:GetChildren() do
            local ok2, child_cur = pcall(function()
                return child.CanCollide
            end)
            
            if ok2 and typeof(child_cur) == "boolean" then
                local ok3 = pcall(function()
                    child.CanCollide = not child_cur
                end)
                
                if ok3 then
                    any = true
                end
            end
        end
        
        return any
    end
    
    return false
end

local function scan()
    local items = ws:GetDescendants()
    local count = 0
    
    for i = 1, cache_size do
        cache[i] = nil
    end
    
    for i = 1, #items do
        local obj = items[i]
        
        if has_pos(obj) then
            count = count + 1
            cache[count] = obj
        end
    end
    
    cache_size = count
    last_scan = os.clock()
    
    return count
end

local function check_keys()
    local now = os.clock()
    if now - last_key < debounce then
        return false, false
    end
    
    last_key = now
    local keys = getpressedkeys()
    local toggle_pressed = false
    local collide_pressed = false
    
    for i = 1, #keys do
        local key = tostring(keys[i]):lower()
        if key == toggle then
            toggle_pressed = true
        elseif key == collide then
            collide_pressed = true
        end
    end
    
    return toggle_pressed, collide_pressed
end

local function find_closest(mx, my, cam)
    local closest = nil
    local closest_screen = nil
    local min_dist = radius * radius
    
    for i = 1, cache_size do
        local obj = cache[i]
        local pos = get_pos(obj)
        
        if pos then
            local screen, vis = cam:WorldToScreenPoint(pos)
            
            if vis then
                local dx = screen.X - mx
                local dy = screen.Y - my
                local dist = dx * dx + dy * dy
                
                if dist < min_dist then
                    min_dist = dist
                    closest = obj
                    closest_screen = screen
                end
            end
        end
    end
    
    if closest then
        cur_dist = math.sqrt(min_dist)
    else
        cur_dist = radius
    end
    
    return closest, closest_screen
end

local function draw_info(obj, pos, screen, mx, my, cam)
    if not obj or not pos or not screen then return end
    
    local name = obj.Name
    local cls = obj.ClassName
    local path = get_path(obj)
    local col = get_col(obj)
    
    local pos_txt = string.format("%.1f, %.1f, %.1f", pos.X, pos.Y, pos.Z)
    local txt = name .. " [" .. cls .. "]\n" ..
                "Path: " .. path .. "\n" ..
                "Pos: " .. pos_txt .. "\n" ..
                "Collide: " .. col
    
    local bounds = f.GetTextBounds("Proggy", 13, txt)
    local w = bounds.X + 20
    local h = bounds.Y + 20
    
    local bx = mx + 25
    local by = my + 25
    
    local view = cam.ViewportSize
    if bx + w > view.X then
        bx = mx - w - 25
    end
    if by + h > view.Y then
        by = my - h - 25
    end
    
    f.FilledRectangle(vector.create(bx, by), vector.create(w, h), bg, 1.0)
    f.Rectangle(vector.create(bx, by), vector.create(w, h), border, 1.0, 1)
    f.Text(vector.create(bx + 10, by + 10), 13, text, 1.0, txt, false, "Proggy")
end

scan()

rs.Render:Connect(function()
    frame = frame + 1
    
    local toggle_pressed, collide_pressed = check_keys()
    
    if toggle_pressed then
        on = not on
    end
    
    if not on then
        local mouse = getmouseposition()
        if mouse then
            f.Text(
                vector.create(mouse.X + 20, mouse.Y + 20),
                12,
                Color3.fromRGB(255, 50, 50),
                1.0,
                "OFF",
                false,
                "Proggy"
            )
        end
        return
    end
    
    local mouse = getmouseposition()
    if not mouse then return end
    local mx, my = mouse.X, mouse.Y
    
    local cam = ws.CurrentCamera
    if not cam then return end
    
    local now = os.clock()
    if now - last_scan > scan_int then
        scan()
    end
    
    local closest, screen = find_closest(mx, my, cam)
    
    if collide_pressed and closest then
        if toggle_col(closest) then
            scan()
            closest = nil
        end
    end
    
    cur = closest
    
    f.FilledCircle(vector.create(mx, my), 6, pink, 1.0)
    f.FilledCircle(vector.create(mx, my), 3, Color3.fromRGB(255, 255, 255), 1.0)
    
    if closest and screen then
        local pos = get_pos(closest)
        
        if pos then
            f.Line(
                vector.create(mx, my),
                vector.create(screen.X, screen.Y),
                line,
                0.8, 1, 2
            )
            
            f.Circle(
                vector.create(screen.X, screen.Y),
                10,
                line,
                0.6, 2
            )
            
            draw_info(closest, pos, screen, mx, my, cam)
        end
    end
end)
